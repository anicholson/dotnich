
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Building a MIDI Synth with a Raspberry Pi  | andrewdotnich</title>

<meta name="author" content="Andy Nicholson"> 

<meta name="description" content="build software, build people"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="andrewdotnich" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" >
	<link rel="apple-touch-icon" href="/apple-touch-icon.png" >
	<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png" >
	<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png" >
	<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png" >
	<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png" >
	<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png" >
	<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png" >
	<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png" >
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
	<link href='/stylesheets/font-mfizz.css' rel='stylesheet' type='text/css'>
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Building a MIDI Synth with a Raspberry Pi">
  <meta name="twitter:url" content="http://andrewdotni.ch//blog/2015/02/28/midi-synth-with-raspberry-p/">
  <meta name="twitter:description" content="build software, build people">
  <meta name="twitter:image" content="http://andrewdotni.ch//favicon.png">
  <meta name="twitter:site" content=" @andrewdotnich ">
  <meta name="twitter:creator" content=" @andrewdotnich ">

  <meta property="og:type" content="blog">
  <meta property="og:title" content="Building a MIDI Synth with a Raspberry Pi">
  <meta property="og:url" content="http://andrewdotni.ch//blog/2015/02/28/midi-synth-with-raspberry-p/">
  <meta property="og:image" content="http://andrewdotni.ch//apple-touch-icon-152x152.png">
  <meta property="og:site_name" content="andrewdotnich">

</head>



<body>
	<header id="header" class="inner"><h1><a href="/">andrewdotnich</a></h1>
<h4>build software, build people</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/precis">Précis</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/katas">Katas</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/precis">Précis</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/katas">Katas</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:andrewdotni.ch/">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">Building a MIDI Synth With a Raspberry Pi</h2>
	<div class="entry-content"><h1>Background</h1>

<p>I’m a keyboard/piano player, but I’m learning <a href="http://www.marcodi.com/">the Harpejji G16</a> as well. When playing in my band, I’ve tried playing bass lines with my left hand on the keys, and leads on the harpejji with my right hand. Unfortunately, the stage piano I’ve been using is too big to sit nicely with the harpejji, and attempting V-like instrument arrangements simply gave me RSI. I needed something smaller that was really easy to use, with as little setup as switching on my current keyboard!
Part of my <a href="/blog/2015/01/08/welcome-to-2015/">year of projects</a>.</p>

<h1>What you need for this Guide</h1>

<ul>
<li>A <a href="http://www.raspberrypi.org/">Raspberry Pi</a>, connected to the Internet. (I’m using an original Model B)</li>
<li>A USB MIDI controller (I’m using an old <a href="http://www.behringer.com/EN/Products/UMX25.aspx">Behringer U-CONTROL UMX-25</a>)</li>
<li>An SD Card with Raspbian installed. The <a href="http://www.raspberrypi.org/help/noobs-setup/">NOOBS method</a> is probably easiest.</li>
<li>Speakers to plug into your Pi, for troubleshooting.</li>
<li>Option A: Monitor &amp; keyboard, for interacting with the Pi directly.</li>
<li>Option B: another PC for SSHing to your PI.</li>
</ul>


<h1>Preparing your Pi</h1>

<p>There’s a little bit of work required to get acceptable results out of your Pi. We’ll overlock this Pi, so you will need to power your Pi from a mains power supply to make sure it gets the juice it needs. From here on, we’ll assume you’ve logged into your Pi as the <code>pi</code> user and have a terminal to enter commands.</p>

<h2>Overclocking</h2>

<p>Run <code>sudo raspi-config</code>, and select Overclock from the menu.</p>

<p><img src="/images/raspi-turbo.png"></p>

<p>As I won’t be using this Pi for anything else, I’ve chosen to run it at the highest overlock, Turbo. If you’re not comfortable with this, you may choose a slightly less aggressive setting. Play around and find what works best for you.</p>

<h2>Create a Separate User</h2>

<p>Depending on what you’re trying to do, this step might not be necessary. But if, like me, you want to switch the Pi on and have things “just work”, you’ll want to do this.</p>

<p>Run the following commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo useradd -G audio synth
</span></code></pre></td></tr></table></div></figure>


<p>This creates the <code>audio</code> group, and adds a new user called <code>synth</code> to the Pi. It also sets the synth user&rsquo;s primary group to <code>audio</code>. This is more important if you want to run your audio through the JACK audio server. I&rsquo;m choosing not to here, but it&rsquo;s an option. If you do decide to investigate JACK further, <a href="http://tedfelix.com/linux/linux-midi.html">Ted&rsquo;s Linux MIDI Guide</a> has some useful information.</p>

<p>Next, we want to allow the <code>synth</code> user to run commands with elevated privileges using <code>sudo</code>. Run <code>sudo visudo</code>, which will bring up the sudoers file.</p>

<p>Navigate to the bottom of the file, and add this line:
<code>synth ALL=(ALL) NOPASSWD: ALL</code></p>

<p>Save and exit the text editor. If no errors come up, the <code>synth</code> user should now be able to run <code>sudo</code> without needing a password.</p>

<h1>Setting up the MIDI</h1>

<p>Plug your MIDI controller into one of the Pi&rsquo;s USB ports, and make sure it&rsquo;s turned on.</p>

<p>Run <code>aconnect -o</code>, and look for your MIDI controller in the output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aconnect -o
</span><span class='line'>client 14: <span class="s1">&#39;Midi Through&#39;</span> <span class="o">[</span><span class="nb">type</span><span class="o">=</span>kernel<span class="o">]</span>
</span><span class='line'>    <span class="m">0</span> <span class="s1">&#39;Midi Through Port-0&#39;</span>
</span><span class='line'>client 20: <span class="s1">&#39;UMX 25&#39;</span> <span class="o">[</span><span class="nb">type</span><span class="o">=</span>kernel<span class="o">]</span>
</span><span class='line'>    <span class="m">0</span> <span class="s1">&#39;UMX 25 MIDI 1   &#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Write down your controller&rsquo;s <strong>client number</strong> - you&rsquo;ll be needing it later.</p>

<p>To verify that MIDI events are being sent, run <code>aseqdump -p *xx*</code> (replacing xx with the client number you just wrote down). Play some keys, and verify that note on/off messages are coming through.</p>

<h1>Making Some Noise</h1>

<p>There are a few options you can choose to generate sound from your Pi, but I’m going with <a href="http://fluidsynth.org/">FluidSynth</a>. CPU cycles are precious on a lower-powered device, so more complicated audio software may not work as well. YMMV.</p>

<p>Plug your speakers into the Pi&rsquo;s stereo output, and make sure they&rsquo;re switched on with the volume at a low-medium level.</p>

<p>At your Pi&rsquo;s terminal (again, assuming you&rsquo;re logged in as the <code>pi</code> user):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt-get update
</span><span class='line'><span class="nv">$ </span>sudo apt-get install fluidsynth
</span><span class='line'>
</span><span class='line'><span class="c"># Try running the aplay -L command. If the Pi complains about aplay not being found, run this too:</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>sudo apt-get install alsa
</span><span class='line'>
</span><span class='line'><span class="c"># Now run:</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>aplay /usr/share/sounds/alsa/Noise.wav
</span></code></pre></td></tr></table></div></figure>


<p>If everything worked properly, you should have heard noise come out of your speakers!</p>

<h1>Wiring it all together</h1>

<p>This can get a little fiddly, and I found it helpful to have 2 terminals open on the Pi at once.</p>

<p>In terminal 1, run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fluidsynth --audio-driver<span class="o">=</span>alsa --gain <span class="m">3</span> /usr/share/sounds/sf2/FluidR3_GM.sf2
</span><span class='line'>
</span><span class='line'>FluidSynth version 1.1.5
</span><span class='line'>Copyright <span class="o">(</span>C<span class="o">)</span> 2000-2011 Peter Hanappe and others.
</span><span class='line'>Distributed under the LGPL license.
</span><span class='line'>SoundFont<span class="o">(</span>R<span class="o">)</span> is a registered trademark of E-mu Systems, Inc.
</span><span class='line'>
</span><span class='line'>fluid synth: warning: Requested a period size of 64, got <span class="m">256</span> instead
</span><span class='line'>Type <span class="s1">&#39;help&#39;</span> <span class="k">for</span> <span class="nb">help </span>topics.
</span><span class='line'>
</span><span class='line'>&gt;
</span></code></pre></td></tr></table></div></figure>


<p>In terminal 2, run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aconnect -o
</span><span class='line'>
</span><span class='line'>client 14: <span class="s1">&#39;Midi Through&#39;</span> <span class="o">[</span><span class="nb">type</span><span class="o">=</span>kernel<span class="o">]</span>
</span><span class='line'>    <span class="m">0</span> <span class="s1">&#39;Midi Through Port-0&#39;</span>
</span><span class='line'>client 20: <span class="s1">&#39;UMX 25&#39;</span> <span class="o">[</span><span class="nb">type</span><span class="o">=</span>kernel<span class="o">]</span>
</span><span class='line'>    <span class="m">0</span> <span class="s1">&#39;UMX 25 MIDI 1   &#39;</span>
</span><span class='line'>client 128: <span class="s1">&#39;FLUID Synth (1179)&#39;</span> <span class="o">[</span><span class="nb">type</span><span class="o">=</span>user<span class="o">]</span>
</span><span class='line'>    <span class="m">0</span> <span class="s1">&#39;Synth input port (1179:0)&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Write down the client number for Fluidsynth as well.</p>

<p>Now let&rsquo;s hook up both ends! In terminal 2, run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># xx is your midi controller, yy fluidsynth</span>
</span><span class='line'><span class="nv">$ </span>aconnect xx:0 yy:0
</span></code></pre></td></tr></table></div></figure>


<p>Play some notes on your keyboard - you should hear some piano sounds come out of your speakers!</p>

<h1>Automating everything</h1>

<p>Doing all the setup is fine and good, but I&rsquo;m not going to lug a keyboard around and run everything each time I power on the Pi! Let&rsquo;s get it happening automatically.</p>

<blockquote><p>WARNING: Getting these next steps wrong could stop your Pi booting properly. Be careful!</p></blockquote>

<h2>Switching to upstart</h2>

<p>Run <code>sudo apt-get install upstart</code>, following the warnings carefully, then reboot your Pi.</p>

<h2>Autologin</h2>

<p>Now we&rsquo;ll set the Pi to autologin the <code>synth</code> user we made earlier. Backup <code>/etc/init/tty1.conf</code>, then edit it with sudo privileges so it looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># tty1 - getty
</span><span class='line'>#
</span><span class='line'># This service maintains a getty on tty1 from the point the system is
</span><span class='line'># started until it is shut down again.
</span><span class='line'>
</span><span class='line'>start on stopped rc RUNLEVEL=[2345] and (
</span><span class='line'>            not-container or
</span><span class='line'>            container CONTAINER=lxc or
</span><span class='line'>            container CONTAINER=lxc-libvirt)
</span><span class='line'>
</span><span class='line'>stop on run level [!2345]
</span><span class='line'>
</span><span class='line'>respawn
</span><span class='line'>exec /sbin/getty -8 -a synth 38400 tty1</span></code></pre></td></tr></table></div></figure>


<p>This will automatically login the <code>synth</code> user on the first terminal. You can verify this by plugging a monitor into the Pi and rebooting it &ndash; instead of seeing a login prompt you should see a shell for <code>synth</code>.</p>

<h2>.profile</h2>

<p>Whenever you log into a Linux machine, a script called <code>.profile</code> gets run. Adding our fluidsynth setup from earlier (with a few tweaks) will run everything whenever the Pi is booted up.</p>

<p>Add the following to the end of <code>/home/synth/.profile</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Run fluidsynth, but this time as a non-interactive server</span>
</span><span class='line'>fluidsynth -is --audio-driver<span class="o">=</span>alsa --gain <span class="m">3</span> /usr/share/sounds/sf2/FluidR3_GM.sf2 <span class="p">&amp;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># give it time to boot up</span>
</span><span class='line'>sleep 10
</span><span class='line'>
</span><span class='line'><span class="c"># connect the controller to fluidsynth</span>
</span><span class='line'><span class="c"># Don&#39;t forget to replace these with the client numbers!</span>
</span><span class='line'>aconnect xx:0 yy:0
</span><span class='line'>
</span><span class='line'><span class="c"># Give fluidsynth a nice high priority so it gets as much CPU as possible!</span>
</span><span class='line'>sudo renice -n -18 -u synth
</span></code></pre></td></tr></table></div></figure>


<p>Reboot your Pi, and when it&rsquo;s finished booting, play some keys and listen to your new synth!</p>

<h1>Troubleshooting</h1>

<h2>ALSA</h2>

<p>If running <code>aplay</code> above didn&rsquo;t make any noise, perhaps you need to tweak your Pi&rsquo;s volume levels. Run <code>alsamixer</code> and check that your output is right:</p>

<p><img src="/images/alsamixer.png"></p>

<p>You should make sure that the output is set to be the Broadcom chip, <em>not</em> HDMI or your MIDI device if you&rsquo;ve plugged it in. You can adjust the volume with the arrow keys &amp;endash if this isn&rsquo;t working, try pressing <code>m</code> to unmute.</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-02-28T15:49:32+11:00" pubdate data-updated="true">Feb 28<sup>th</sup>, 2015</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/audio/'>audio</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/projects/'>projects</a>, <a class='category' href='/blog/categories/raspberry-pi/'>raspberry pi</a>

</div>


	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
<!---	<a class="addthis_counter addthis_pill_style"></a> --->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2016

    Andy Nicholson

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'andrewdotnich';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://andrewdotni.ch//blog/2015/02/28/midi-synth-with-raspberry-p/';
        var disqus_url = 'http://andrewdotni.ch//blog/2015/02/28/midi-synth-with-raspberry-p/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-38204833-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>
